"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),INIT_VIEW="INIT_VIEW",DIALOG_SHOW="DIALOG_SHOW",DIALOG_HAS_DATA="DIALOG_HAS_DATA",SYNC_RESERVATION="SYNC_RESERVATION",SYNC_VUE_STATE="SYNC_VUE_STATE",AJAX_CONFIRM_RESERVATION="AJAX_CONFIRM_RESERVATION",AJAX_CONFIRM_RESERVATION_SUCCESS="AJAX_CONFIRM_RESERVATION_SUCCESS",AJAX_RESERVATION_STILL_NOT_RESERVED="AJAX_RESERVATION_STILL_NOT_RESERVED",ReservationConfirm=function(){function e(){_classCallCheck(this,e),this.buildRedux(),this.buildVue()}return _createClass(e,[{key:"buildRedux",value:function(){var e={init_view:!1,dialog:null},t=window.state||{},a=Object.assign(e,t),i=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:a,t=arguments[1];switch(t.type){case INIT_VIEW:return Object.assign({},e,{init_view:!0});case DIALOG_SHOW:return Object.assign({},e,{dialog:!0});case DIALOG_HAS_DATA:return Object.assign({},e,{dialog:!1});case SYNC_RESERVATION:var i=t.reservation;return Object.assign({},e,{reservation:i});case SYNC_VUE_STATE:return Object.assign({},e,t.vue_state);default:return e}};window.store=Redux.createStore(i);var n=store.dispatch;store.dispatch=function(e){console.info(e.type),store.prestate=store.getState(),store.last_action=e.type,n(e)},store.getPrestate=function(){return store.prestate},store.getLastAction=function(){return store.last_action}}},{key:"initView",value:function(){window.store.dispatch({type:INIT_VIEW})}},{key:"buildVue",value:function(){var e=window.store;e.dispatch({type:DIALOG_SHOW});var t=this,a={base_url:"",selected_outlet:{},reservation:{},paypal_token:null,thank_you_url:""};window.vue_state=a,this.vue=new Vue({el:"#app",data:a,beforeCreate:function(){},created:function(){},beforeUpdate:function(){e.dispatch({type:SYNC_VUE_STATE,vue_state:window.vue_state})},mounted:function(){setTimeout(function(){e.dispatch({type:DIALOG_HAS_DATA})},690),t.event(),t.listener(),t.view(),t.initView()},updated:function(){},watch:{reservation:function(e){var t=!e.date,a=e.reservation_timestamp;if(t&&a){var i=moment(e.reservation_timestamp,"YYYY-MM-DD HH:mm:ss");if(i.isValid()){var n=Object.assign({},e,{date:i});this.reservation=n}}},paypal_token:function e(){var t=this.reservation,a=t.deposit,i=t.confirm_id,n=t.outlet_id,e=this.paypal_token,s=this.base_url,o={amount:a,confirm_id:i,outlet_id:n};new PayPalAuthorize(e,o,s)}},methods:{_confirmReservation:function(){var t=this,a={type:AJAX_CONFIRM_RESERVATION};e.dispatch({type:DIALOG_SHOW}),$.ajax({url:t.base_url,method:"POST",data:a,success:function(a){switch(console.log(a),a.statusMsg){case AJAX_CONFIRM_RESERVATION_SUCCESS:var i=a.data.reservation;e.dispatch({type:SYNC_RESERVATION,reservation:i}),window.location.href=t.thank_you_url;break;default:console.warn("Unknown case",a)}},error:function(t){console.log(t.responseJSON);var a=t.responseJSON;switch(a.statusMsg){case AJAX_RESERVATION_STILL_NOT_RESERVED:var i=a.data.reservation;e.dispatch({type:SYNC_RESERVATION,reservation:i});window.alert("Please complete your payment first. Thank you.");break;default:console.warn("Unknown case",a)}},complete:function(){e.dispatch({type:DIALOG_HAS_DATA})}})}}})}},{key:"_findView",value:function(){this._hasFindView||(this._hasFindView=!0,this.ajax_dialog=$("#ajax-dialog"))}},{key:"event",value:function(){this._findView(),document.addEventListener("PAYPAL_PAYMENT_SUCCESS",function(e){var t=e.detail,a=t.data.reservation;store.dispatch({type:SYNC_RESERVATION,reservation:a})})}},{key:"view",value:function(){var e=this,t=window.store,a=document.querySelector("#redux-state");t.subscribe(function(){var t=window.store,i=t.getState(),n=(t.getPrestate(),t.getLastAction()),s=e,o=i.base_url&&i.base_url.includes("reservation.dev")||i.base_url.includes("localhost");if(a&&o){var r=Object.assign({},i);if(r.available_time){Object.keys(r.available_time).length>14&&(delete r.available_time,console.warn("available_time is large, debug build HTML will slow app, removed it"))}a.innerHTML=syntaxHighlight(JSON.stringify(r,null,4))}n==DIALOG_SHOW&&s.ajax_dialog.modal("show"),n==DIALOG_HAS_DATA&&s.ajax_dialog.modal("hide"),Object.assign(window.vue_state,i)})}},{key:"listener",value:function(){}}]),e}(),reservationConfirm=new ReservationConfirm;