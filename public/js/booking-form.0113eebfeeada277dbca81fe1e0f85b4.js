"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),BookingForm=function(){function e(){_classCallCheck(this,e),this.buildRedux(),this.bindView(),this.regisEvent(),this.bindListener(),this.initView()}return _createClass(e,[{key:"buildRedux",value:function(){this.state=this.defaultState();var e=this,t=Redux.combineReducers({has_selected_day:e.buildHasSelectedDayReducer(),available_time:e.buildAvailableTimeReducer(),reservation:e.buildReservationReducer(),ajax_call:e.buildAjaxCallReducer(),init_view:e.buildInitViewReducer(),outlet:e.buildOutletReducer(),dialog:e.buildDialogReducer(),pax:e.buildPaxReducer()});window.store=Redux.createStore(t);var a=store.dispatch;store.dispatch=function(e){store.prestate=store.getState(),a(e)},store.getPrestate=function(){return store.prestate}}},{key:"defaultState",value:function(){return window.booking_form_state?window.booking_form_state:{init_view:!1,outlet:{id:1,name:"HoiPOS Cafe (West)"},pax:{adult:1,children:0},reservation:{date:moment(),time:""},dialog:{show:!1,stop:{has_data:!1,exceed_min_exist_time:!1},min_exist_time:2070},available_time:{},ajax_call:!1,has_selected_day:!1}}},{key:"buildOutletReducer",value:function(){var e=this.state.outlet;return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e,a=arguments[1];switch(a.type){case"CHANGE_OUTLET":return a.outlet;default:return t}}}},{key:"buildPaxReducer",value:function(){var e=this.state.pax;return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e,a=arguments[1];switch(a.type){case"CHANGE_ADULT_PAX":return Object.assign({},t,{adult:a.adult_pax});case"CHANGE_CHILDREN_PAX":return Object.assign({},t,{children:a.children_pax});default:return t}}}},{key:"buildReservationReducer",value:function(){var e=this.state.reservation;return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e,a=arguments[1];switch(a.type){case"CHANGE_RESERVATION_DATE":return Object.assign({},t,{date:a.date});case"CHANGE_RESERVATION_TIME":return Object.assign({},t,{time:a.time});default:return t}}}},{key:"buildDialogReducer",value:function(){var e=this.state.dialog;return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e,a=arguments[1];switch(a.type){case"DIALOG_SHOW":return Object.assign({},t,{show:a.show});case"DIALOG_HAS_DATA":return t.stop.has_data=a.dialog_has_data,JSON.parse(JSON.stringify(t));case"DIALOG_EXCEED_MIN_EXIST_TIME":return t.stop.exceed_min_exist_time=a.exceed_min_exist_time,JSON.parse(JSON.stringify(t));case"DIALOG_HIDE":return t.show=!1,t.stop.has_data=!1,JSON.parse(JSON.stringify(t));case"DIALOG_HIDDEN":return t.stop.exceed_min_exist_time=!1,JSON.parse(JSON.stringify(t));default:return t}}}},{key:"buildAvailableTimeReducer",value:function(){var e=this.state.available_time;return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e,a=arguments[1];switch(a.type){case"CHANGE_AVAILABLE_TIME":return Array.isArray(a.available_time)&&(a.available_time={}),a.available_time;default:return t}}}},{key:"buildInitViewReducer",value:function(){var e=this.state.init_view;return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e;switch(arguments[1].type){case"INIT_VIEW":return!0;default:return t}}}},{key:"buildAjaxCallReducer",value:function(){var e=this.state.ajax_call;return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e,a=arguments[1];switch(a.type){case"AJAX_CALL":return a.ajax_call;default:return t}}}},{key:"buildHasSelectedDayReducer",value:function(){var e=this.state.has_selected_day;return function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e;switch(arguments[1].type){case"HAS_SELECTED_DAY":return!0;default:return t}}}},{key:"bindListener",value:function(){var e=this,t=window.store,a=this;t.subscribe(function(){var i=t.getState(),n=t.getPrestate();n&&(!n.has_selected_day||n.pax.adult==i.pax.adult&&n.pax.children==i.pax.children&&n.outlet.id==i.outlet.id||a.ajaxCall(),0==n.has_selected_day&&1==i.has_selected_day&&a.ajaxCall(),n.reservation.date!=i.reservation.date&&a.ajaxCall()),1==i.dialog.show&&1==i.dialog.stop.has_data&&1==i.dialog.stop.exceed_min_exist_time&&(t.dispatch({type:"DIALOG_HIDE"}),e.ajax_dialog.modal("hide"))})}},{key:"bindView",value:function(){var e=this;this.findView();var t=window.store,a=document.querySelector("#redux-state");if(!a){var i=document.querySelector("body");a=document.createElement("pre"),i.appendChild(a)}t.subscribe(function(){var i=t.getState();a.innerHTML=syntaxHighlight(JSON.stringify(i,null,4)),e.input_outlet.value=i.outlet.name,e.label.innerText=i.reservation.date.format("MMM D Y"),e.inpute_date.value=i.reservation.date.format("Y-MM-DD"),e.reservation_title.innerText=i.outlet.name,e.updateSelectView(i.available_time),1==i.dialog.show&&e.ajax_dialog.modal("show"),e.updateCalendarView(i.available_time)})}},{key:"initView",value:function(){var e={type:"INIT_VIEW"};store.dispatch(e)}},{key:"findView",value:function(){var e=$("#calendar-box");this.calendar=e.Calendar(),this.day_tds=e.find("td.day"),this.label=document.querySelector("#reservation_date"),this.select=document.querySelector('select[name="reservation_time"]'),this.form=document.querySelector("#booking-form"),this.adult_pax_select=document.querySelector('select[name="adult_pax"]'),this.children_pax_select=document.querySelector('select[name="children_pax"]'),this.ajax_dialog=$("#ajax-dialog"),this.outlet_select=document.querySelector('select[name="outlet_id"]'),this.inpute_date=document.querySelector('input[name="reservation_date"]'),this.input_outlet=document.querySelector('input[name="outlet_name"]'),this.time_select=document.querySelector('select[name="reservation_time"]'),this.reservation_title=document.querySelector("#reservation_title")}},{key:"updateSelectView",value:function(e){var t=moment().format("Y-MM-DD"),a=e[t];if(void 0===a&&(console.info("No available time on select day"),a=[]),0==a.length){var i={time:"N/A",session_name:""};a.push(i)}var n=this.select;n.available_time&&n.available_time==e||(n.available_time=e,n.innerHTML="",a.forEach(function(e){var t=document.createElement("option");t.setAttribute("value",e.time),t.innerText=e.session_name+" "+e.time,n.appendChild(t)}))}},{key:"updateCalendarView",value:function(e){if(0!=Object.keys(e).length){var t=this.calendar;if(this._addCalendarHelper(t),t.available_time)return void t.available_time;t.available_time=e;var a=Object.keys(e);this.day_tds.each(function(){var e=$(this),i=e.attr("year")+"-"+t._prefix2Dec(e.attr("month"))+"-"+t._prefix2Dec(e.attr("day"));a.includes(i)?t._pickable(e):t._unpickable(e)})}}},{key:"_addCalendarHelper",value:function(e){e._prefix2Dec&&e._pickable&&!e._unpickable||(e._prefix2Dec=function(e){return e<10?"0"+e:e},e._pickable=function(e){e.removeClass("past"),e.addClass("day")},e._unpickable=function(e){e.removeClass("day"),e.addClass("past")})}},{key:"regisEvent",value:function(){var e=window.store,t=this.outlet_select;t.addEventListener("change",function(){var a=t.selectedOptions[0];e.dispatch({type:"CHANGE_OUTLET",outlet:{id:a.value,name:a.innerText}})});var a=this.adult_pax_select;a.addEventListener("change",function(){var t=a.selectedOptions[0];e.dispatch({type:"CHANGE_ADULT_PAX",adult_pax:t.value})});var i=this.children_pax_select;i.addEventListener("change",function(){var t=i.selectedOptions[0];e.dispatch({type:"CHANGE_CHILDREN_PAX",children_pax:t.value})}),document.addEventListener("user-select-day",function(t){var a=moment(t.detail.day,"Y-M-D");e.dispatch({type:"CHANGE_RESERVATION_DATE",date:a}),e.dispatch({type:"HAS_SELECTED_DAY"})});var n=this.time_select;n.addEventListener("change",function(){console.log("time change");var t=n.selectedOptions[0],a={type:"CHANGE_RESERVATION_TIME",time:t.value};e.dispatch(a)}),this.ajax_dialog.on("hidden.bs.modal",function(){console.log("dialog hidden"),e.dispatch({type:"DIALOG_HIDDEN"})})}},{key:"ajaxCall",value:function(){var e=this.form,t=$(e).serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{}),a=window.store,i=a.getState();a.dispatch({type:"DIALOG_SHOW",show:!0});var n=setTimeout(function(){a.dispatch({type:"DIALOG_EXCEED_MIN_EXIST_TIME",exceed_min_exist_time:!0}),clearTimeout(n)},i.dialog.min_exist_time);$.ajax({url:"",method:"POST",data:t,success:function(e){console.log(e),a.dispatch({type:"CHANGE_AVAILABLE_TIME",available_time:e})},complete:function(){a.dispatch({type:"DIALOG_HAS_DATA",dialog_has_data:!0}),a.dispatch({type:"AJAX_CALL",ajax_call:!1})}})}}]),e}(),bookingForm=new BookingForm;