"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),INIT_VIEW="INIT_VIEW",CHANGE_ADMIN_STEP="CHANGE_ADMIN_STEP",ADD_WEEKLY_SESSION="ADD_WEEKLY_SESSION",ADD_SPECIAL_SESSION="ADD_SPECIAL_SESSION",UPDATE_WEEKLY_SESSIONS="UPDATE_WEEKLY_SESSIONS",SYNC_DATA="SYNC_DATA",DELETE_TIMING="DELETE_TIMING",DELETE_SESSION="DELETE_SESSION",DELETE_SPECIAL_SESSION="DELETE_SPECIAL_SESSION",UPDATE_SPECIAL_SESSIONS="UPDATE_SPECIAL_SESSIONS",SAVE_EDIT_IN_VUE_TO_STORE="SAVE_EDIT_IN_VUE_TO_STORE",UPDATE_BUFFER="UPDATE_BUFFER",UPDATE_NOTIFICATION="UPDATE_NOTIFICATION",UPDATE_SETTINGS="UPDATE_SETTINGS",UPDATE_DEPOSIT="UPDATE_DEPOSIT",REFETCHING_DATA="REFETCHING_DATA",REFETCHING_DATA_SUCCESS="REFETCHING_DATA_SUCCESS",SWITCH_OUTLET="SWITCH_OUTLET",AJAX_UPDATE_SCOPE_OUTLET_ID="AJAX_UPDATE_SCOPE_OUTLET_ID",SHOW_USER_DIALOG="SHOW_USER_DIALOG",UPDATE_SINGLE_USER="UPDATE_SINGLE_USER",TOAST_SHOW="TOAST_SHOW",AJAX_ADD_WEEKLY_SESSIONS="AJAX_ADD_WEEKLY_SESSIONS",AJAX_UPDATE_WEEKLY_SESSIONS="AJAX_UPDATE_WEEKLY_SESSIONS",AJAX_DELETE_WEEKLY_SESSIONS="AJAX_DELETE_WEEKLY_SESSIONS",AJAX_UPDATE_SESSIONS="AJAX_UPDATE_SESSIONS",AJAX_UPDATE_BUFFER="AJAX_UPDATE_BUFFER",AJAX_UPDATE_NOTIFICATION="AJAX_UPDATE_NOTIFICATION",AJAX_UPDATE_SETTINGS="AJAX_UPDATE_SETTINGS",AJAX_UPDATE_DEPOSIT="AJAX_UPDATE_DEPOSIT",AJAX_REFETCHING_DATA="AJAX_REFETCHING_DATA",AJAX_UNKNOWN_CASE="AJAX_UNKNOWN_CASE",AJAX_UPDATE_SESSIONS_SUCCESS="AJAX_UPDATE_SESSIONS_SUCCESS",AJAX_VALIDATE_FAIL="AJAX_VALIDATE_FAIL",AJAX_SUCCESS="AJAX_SUCCESS",AJAX_ERROR="AJAX_ERROR",AJAX_REFETCHING_DATA_SUCCESS="AJAX_REFETCHING_DATA_SUCCESS",AJAX_UPDATE_SCOPE_OUTLET_ID_SUCCESS="AJAX_UPDATE_SCOPE_OUTLET_ID_SUCCESS",HIDE_USER_DIALOG="HIDE_USER_DIALOG",AdminSettings=function(){function e(){_classCallCheck(this,e),this.buildRedux(),this.buildVue(),this.initView()}return _createClass(e,[{key:"buildRedux",value:function(){var e=this,t=this.defaultState(),s=function(){var s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:t,i=arguments[1];switch(i.type){case INIT_VIEW:return Object.assign({},s,{init_view:e.initViewReducer(s.init_view,i)});case CHANGE_ADMIN_STEP:return Object.assign({},s,{admin_step:e.adminStepReducer(s.admin_step,i)});case TOAST_SHOW:return Object.assign({},s,{toast:e.toastReducer(s.toast,i)});case SYNC_DATA:return Object.assign(s,i.data);case HIDE_USER_DIALOG:case SHOW_USER_DIALOG:return Object.assign({},s,{user_dialog_content:e.userDialogContentReducer(s.user_dialog_content,i)});default:return s}};window.store=Redux.createStore(s);var i=store.dispatch;store.dispatch=function(e){console.info(e.type),store.prestate=store.getState(),store.last_action=e.type,i(e)},store.getPrestate=function(){return store.prestate},store.getLastAction=function(){return store.last_action}}},{key:"getFrontendState",value:function(){return{init_view:!1,admin_step:"weekly_sessions_view",user_dialog_content:{outlet_ids:[]},deleted_sessions:[],deleted_timings:[],toast:{title:"Title",content:"Content"}}}},{key:"defaultState",value:function(){var e=window.state||{},t=this.getFrontendState();return Object.assign(e,t)}},{key:"buildVue",value:function(){window.vue_state=this.buildVueState();var e=this;this.vue=new Vue({el:"#app",data:window.vue_state,mounted:function(){document.dispatchEvent(new CustomEvent("vue-mounted")),e.event(),e.view(),e.listener()},updated:function(){console.time("$ bind time-picker"),$(".jonthornton-time").timepicker({step:30,disableTextInput:!0}).on("change",function(){var e=$(this),t=e[0],s=e.val();t.dispatchEvent(new CustomEvent("$change",{detail:{value:s}}))}),console.timeEnd("$ bind time-picker")},methods:{_askRecomputeWeeklyView:function(){},_addWeeklySession:function(){var t=e._dumpWeeklySession();this.weekly_sessions.push(t),this._askRecomputeWeeklyView()},_addTimingToSession:function(t){console.log("see add timing");var s=t.target,i=s.getAttribute("session-index");this.weekly_sessions[i].timings.push(e._dumpTiming())},_deleteSession:function(e){console.log("see delete session");try{var t=this._findIElement(e),s=t.getAttribute("session-index"),i=this.weekly_sessions[s];this.weekly_sessions.splice(s,1),this.deleted_sessions.push(i)}catch(e){return}},_updateSingleTimingArrival:function(e,t,s){var i=s.detail;e[t]=i.value},_timingsMounted:function(){console.log("see timings mounted")},_deleteTiming:function(e){console.log("see delete timing");try{var t=this._findIElement(e),s=t.getAttribute("session-index"),i=t.getAttribute("timing-index"),n=this.weekly_sessions[s],a=n.timings[i];n.timings.splice(i,1),this.deleted_timings.push(a)}catch(e){return}},_addSpecialSession:function(){var t=e._dumpSpecialSession();this.special_sessions.push(t),this._askRecomputeWeeklyView()},_addTimingToSpecialSession:function(t){console.log("see add timing");var s=t.target,i=s.getAttribute("session-index");this.special_sessions[i].timings.push(e._dumpTiming())},_deleteSpecialSession:function(e){console.log("see delete session");try{var t=this._findTrElement(e),s=t.getAttribute("session-index"),i=this.special_sessions[s];this.special_sessions.splice(s,1),this.deleted_sessions.push(i)}catch(e){return}},_deleteTimingInSpecialSession:function(e){console.log("see delete timing");try{var t=this._findTrElement(e),s=t.getAttribute("session-index"),i=t.getAttribute("timing-index"),n=this.special_sessions[s],a=n.timings[i];n=n.timings.splice(i,1),this.deleted_timings.push(a)}catch(e){return}},_findIElement:function(e){var t=e.target;if("I"==t.tagName)return t;if("BUTTON"==t.tagName){return t.querySelector("i")}return null},_updateWeeklySessions:function(){var t=this;this._resolveTimingArrivalTime(t.weekly_sessions);var s={type:AJAX_UPDATE_SESSIONS,sessions:t.weekly_sessions,deleted_sessions:t.deleted_sessions,deleted_timings:t.deleted_timings};e.ajax_call(s)},_updateSpecialSession:function(){var t=this;this._resolveTimingArrivalTime(t.special_sessions);var s={type:AJAX_UPDATE_SESSIONS,sessions:t.special_sessions,deleted_sessions:t.deleted_sessions,deleted_timings:t.deleted_timings};e.ajax_call(s)},_updateBuffer:function(){var t=this,s={type:AJAX_UPDATE_BUFFER,buffer:t.buffer};e.ajax_call(s)},_updateNotification:function(){var t=this,s={type:AJAX_UPDATE_NOTIFICATION,notification:t.notification};e.ajax_call(s)},_updateSettings:function(){if(0==this.settings.users.filter(function(e){return 10==e.permission_level}).length){var t={title:"Settings > Users",content:"Need at least one Administrator",type:"danger"};return void store.dispatch({type:TOAST_SHOW,toast:t})}var s={type:AJAX_UPDATE_SETTINGS,settings:this.settings};e.ajax_call(s)},_updateDeposit:function(){var t={type:AJAX_UPDATE_DEPOSIT,deposit:this.deposit};e.ajax_call(t)},_updateSingleUser:function(){console.log("see you click");var e=this.user_dialog_content;if(e.reset_password){if(!e.password||e.password.length<6)return void(e.password_error=!0);if(e.password_error=!1,e.password!=e.confirm_password)return void(e.password_mismatch=!0);e.password_mismatch=!1}store.dispatch({type:HIDE_USER_DIALOG});for(var t=this.user_dialog_content,s=this.settings.users,i=0,n=!1;i<s.length&&!n;)s[i].id==t.id&&(n=!0),i++;var a=s[i-1];Object.keys(a).forEach(function(e){a[e]=t[e]});var o=t.reset_password,_=t.password;Object.assign(a,{reset_password:o,password:_}),this._updateSettings()},_wantToChangePassword:function(){console.log("see as for reset password"),this.user_dialog_content.reset_password=!0,this.user_dialog_content.password="",this.user_dialog_content.confirm_password=""},_updateUserDialog:function(e){console.log("see tr click");try{var t=this._findTrElement(e),s=t.getAttribute("user-index"),i=this.settings.users[s],n=Object.assign({},i);n.reset_password=!1,n.password="xxxxxx",n.confirm_password="xxxxxx",n.password_mismatch=!1,n.password_error=!1,Object.assign(window.vue_state,{user_dialog_content:n}),store.dispatch({type:SHOW_USER_DIALOG})}catch(e){}},_findTrElement:function(e){for(var t=e.target,s=[t].concat(e.path),i=0;i<s.length;){var n=s[i];if("INPUT"==n.tagName||"TEXTAREA"==n.tagName||"SELECT"==n.tagName)return null;if("TR"==n.tagName)return n;i++}return null},_updateTimingDisabled:function(e){console.log(e);var t=e.target;if("INPUT"==t.tagName)try{var s=t.getAttribute("session-id"),i=t.getAttribute("timing-index"),n=this.weekly_sessions.filter(function(e){return e.id==s});if(0==n.length&&(n=this.special_sessions.filter(function(e){return e.id==s})),0==n.length)return;n[0].timings[i].disabled=!t.checked}catch(e){return}},_resolveTimingArrivalTime:function(e){}}})}},{key:"buildVueState",value:function(){var e=Object.assign({},store.getState()),t={weekly_view:{}};return Object.assign(e,t),e}},{key:"initViewReducer",value:function(e,t){switch(t.type){case INIT_VIEW:return!0;default:return e}}},{key:"initView",value:function(){store.dispatch({type:INIT_VIEW})}},{key:"userDialogContentReducer",value:function(e,t){switch(t.type){case SHOW_USER_DIALOG:case HIDE_USER_DIALOG:return e;default:return e}}},{key:"adminStepReducer",value:function(e,t){switch(t.type){case CHANGE_ADMIN_STEP:return t.step;default:return e}}},{key:"_randomId",value:function(){return Math.random().toString(36).slice(-4)}},{key:"_dumpWeeklySession",value:function(){return{id:null,outlet_id:window.store.getState().outlet_id,session_name:"Lunch time",on_mondays:1,on_tuesdays:1,on_wednesdays:1,on_thursdays:1,on_fridays:1,on_saturdays:1,on_sundays:1,one_off:0,one_off_date:null,first_arrival_time:"10:00:00",last_arrival_time:"13:00:00",timings:[this._dumpTiming()]}}},{key:"_dumpTiming",value:function(){return{id:null,session_id:null,timing_name:"timing x",disabled:!1,first_arrival_time:"10:00:00",last_arrival_time:"11:00:00",interval_minutes:30,capacity_1:1,capacity_2:1,capacity_3_4:1,capacity_5_6:1,capacity_7_x:1,max_pax:20,children_allowed:!0,is_outdoor:null}}},{key:"toastReducer",value:function(e,t){switch(t.type){case TOAST_SHOW:return t.toast;default:return e}}},{key:"_dumpSpecialSession",value:function(){return{id:null,outlet_id:window.store.getState().outlet_id,session_name:"Special session",on_mondays:null,on_tuesdays:null,on_wednesdays:null,on_thursdays:null,on_fridays:null,on_saturdays:null,on_sundays:null,one_off:1,one_off_date:moment().format("YYYY-MM-DD"),timings:[this._dumpTiming()]}}},{key:"_findView",value:function(){this._hasFindView||(this._hasFindView=!0,this.admin_step_container=document.querySelector("#admin-step-container"),this.admin_step_go=document.querySelectorAll(".go"),this.user_dialog=$("#user-dialog"))}},{key:"event",value:function(){this._findView();var e=this;this.admin_step_go.forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("destination");store.dispatch({type:CHANGE_ADMIN_STEP,step:t})})}),document.addEventListener("switch-outlet",function(t){var s=t.detail.outlet_id;store.dispatch({type:TOAST_SHOW,toast:{title:"Switch Outlet",content:"Fecthing data"}});var i={type:AJAX_REFETCHING_DATA,outlet_id:s};e.ajax_call(i)})}},{key:"view",value:function(){var e=window.store,t=this,s=document.querySelector("#redux-state");if(!s){document.querySelector("body");s=document.createElement("pre")}e.subscribe(function(){var i=e.getLastAction(),n=e.getState(),a=e.getPrestate();s.innerHTML=syntaxHighlight(JSON.stringify(n,null,4));var o=0==a.init_view&&1==n.init_view,_=a.admin_step!=n.admin_step;if((o||_)&&t.pointToAdminStep(),i==TOAST_SHOW){var r=n.toast;Object.assign(window.vue_state,{toast:r}),window.Toast.show()}if(i==SHOW_USER_DIALOG&&t.user_dialog.modal("show"),i==HIDE_USER_DIALOG&&t.user_dialog.modal("hide"),i==SYNC_DATA&&Object.assign(window.vue_state,e.getState()),o||i==SYNC_DATA){var l=t.computeWeeklyView();Object.assign(vue_state,{weekly_view:l})}if(i==SYNC_DATA){var u=n.admin_step+"_view";document.querySelector("#"+u)&&e.dispatch({type:CHANGE_ADMIN_STEP,step:u})}})}},{key:"listener",value:function(){var e=window.store;e.subscribe(function(){e.getLastAction(),e.getState(),e.getPrestate()})}},{key:"pointToAdminStep",value:function(){var e=store.getState(),t=store.getPrestate(),s=this.admin_step_container.querySelector("#"+t.admin_step),i=this.admin_step_container.querySelector("#"+e.admin_step);s&&(s.style.transform="scale(0,0)"),i&&(i.style.transform="scale(1,1)")}},{key:"computeWeeklyView",value:function(){var e=window.store,t=e.getState(),s=t.weekly_sessions,i=moment(),n=i.clone().startOf("isoWeek"),a=i.clone().endOf("isoWeek"),o=[];s.forEach(function(e){for(var t=n.clone();t.isBefore(a);){if(1==e["on_"+t.format("dddd").toLocaleLowerCase()+"s"]){var s=Object.assign({},e);s.date=t.clone(),o.push(s)}t.add(1,"days")}});var _=o.reduce(function(e,t){var s=t.date.format("dddd");return void 0===e[s]&&(e[s]=[]),e[s].push(t),e},{});return Object.assign({Monday:null,Tuesday:null,Wednesday:null,Thursday:null,Friday:null,Saturday:null,Sunday:null},_)}},{key:"ajax_call",value:function(e){var t=window.store,s=t.getState(),i=this;switch(t.dispatch({type:TOAST_SHOW,toast:{title:"Calling ajax",content:"..."}}),this.hack_ajax(),e.type){case AJAX_UPDATE_SESSIONS:var n=i.url(""),a=s.outlet_id,o=Object.assign({},e,{outlet_id:a});$.ajax({url:n,data:o});break;case AJAX_UPDATE_BUFFER:case AJAX_UPDATE_NOTIFICATION:case AJAX_UPDATE_SETTINGS:case AJAX_UPDATE_DEPOSIT:var _=i.url(""),r=s.outlet_id,l=Object.assign({},e,{outlet_id:r});$.ajax({url:_,data:l});break;case AJAX_REFETCHING_DATA:var u=i.url(""),c=e;$.ajax({url:u,data:c});break;default:console.log("client side. ajax call not recognize the current acttion",e)}}},{key:"ajax_call_success",value:function(e){switch(console.log(e),e.statusMsg){case AJAX_SUCCESS:var t={title:"Update success",content:"＼＿ヘ(ᐖ◞)､ "};store.dispatch({type:TOAST_SHOW,toast:t}),store.dispatch({type:SYNC_DATA,data:e.data});break;case AJAX_VALIDATE_FAIL:var s={title:"Validate Fail",content:JSON.stringify(e.data)};store.dispatch({type:TOAST_SHOW,toast:s});break;case AJAX_REFETCHING_DATA_SUCCESS:var i={title:"Switch Outlet",content:"Fetched Data"};store.dispatch({type:TOAST_SHOW,toast:i}),store.dispatch({type:SYNC_DATA,data:e.data})}}},{key:"ajax_call_error",value:function(e){console.log(e);var t={title:"Server error",content:"(⊙.☉)7"};store.dispatch({type:TOAST_SHOW,toast:t})}},{key:"ajax_call_complete",value:function(){}},{key:"hack_ajax",value:function(){if(!this._hasHackAjax){this._hasHackAjax=!0;var e=this,t=$.ajax;$.ajax=function(s){var i=s.data,n=JSON.stringify(i);return s=Object.assign(s,{method:"POST",data:n,success:e.ajax_call_success,error:e.ajax_call_error,compelte:e.ajax_call_complete}),t(s)}}}},{key:"url",value:function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",s=window.store,i=s.getState(),n=i.base_url||"";n.endsWith("/")&&(n=t.substr(1)),t.startsWith("/")&&(t=t.substr(1));var e=n+"/"+t;return e.endsWith("/")&&(e=t.substr(1)),e}}]),e}(),adminSettings=new AdminSettings;