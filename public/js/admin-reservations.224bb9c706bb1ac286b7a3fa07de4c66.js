"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),INIT_VIEW="INIT_VIEW",SHOW_RESERVATION_DIALOG_CONTENT="SHOW_RESERVATION_DIALOG_CONTENT",HIDE_RESERVATION_DIALOG_CONTENT="HIDE_RESERVATION_DIALOG_CONTENT",UPDATE_SINGLE_RESERVATION="UPDATE_SINGLE_RESERVATION",UPDATE_RESERVATIONS="UPDATE_RESERVATIONS",SYNC_DATA="SYNC_DATA",REFETCHING_DATA="REFETCHING_DATA",TOAST_SHOW="TOAST_SHOW",REFETCHING_DATA_SUCCESS="REFETCHING_DATA_SUCCESS",AJAX_UPDATE_RESERVATIONS="AJAX_UPDATE_RESERVATIONS",AJAX_UPDATE_SCOPE_OUTLET_ID="AJAX_UPDATE_SCOPE_OUTLET_ID",AJAX_REFETCHING_DATA="AJAX_REFETCHING_DATA",AJAX_UNKNOWN_CASE="AJAX_UNKNOWN_CASE",AJAX_UPDATE_SESSIONS_SUCCESS="AJAX_UPDATE_SESSIONS_SUCCESS",AJAX_UPDATE_SCOPE_OUTLET_ID_SUCCESS="AJAX_UPDATE_SCOPE_OUTLET_ID_SUCCESS",AJAX_SUCCESS="AJAX_SUCCESS",AJAX_ERROR="AJAX_ERROR",AJAX_VALIDATE_FAIL="AJAX_VALIDATE_FAIL",AJAX_REFETCHING_DATA_SUCCESS="AJAX_REFETCHING_DATA_SUCCESS",PAYMENT_REFUNDED=50,PAYMENT_PAID=100,PAYMENT_CHARGED=200,AdminReservations=function(){function t(){_classCallCheck(this,t),this.buildRedux(),this.buildVue(),this.hack_store(),this.hack_ajax(),this.initView()}return _createClass(t,[{key:"buildRedux",value:function(){var t=this,e=this.defaultState(),a=function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e,n=arguments[1];switch(n.type){case INIT_VIEW:return Object.assign({},a,{init_view:t.initViewReducer(a.init_view,n)});case SHOW_RESERVATION_DIALOG_CONTENT:case HIDE_RESERVATION_DIALOG_CONTENT:return Object.assign({},a,{reservation_dialog_content:t.reservationDialogContentReducer(a.reservation_dialog_content,n)});case TOAST_SHOW:return Object.assign({},a,{toast:n.toast});case SYNC_DATA:return Object.assign(a,n.data);default:return a}};window.store=Redux.createStore(a)}},{key:"hack_store",value:function(){var t=window.store,e=t.dispatch;t.dispatch=function(a){console.info(a.type),t.prestate=t.getState(),t.last_action=a.type,e(a)},t.getPrestate=function(){return t.prestate},t.getLastAction=function(){return t.last_action}}},{key:"getFrontEndState",value:function(){return{reservation_dialog_content:{},toast:{title:"Title",content:"Content"}}}},{key:"defaultState",value:function(){var t=window.state||{},e=this.getFrontEndState();return Object.assign(t,e)}},{key:"buildVue",value:function(){window.vue_state=this.buildVueState();var t=this;this.vue=new Vue({el:"#app",data:window.vue_state,mounted:function(){document.dispatchEvent(new CustomEvent("vue-mounted")),t.event(),t.view(),t.listener()},methods:{_reservationDetailDialog:function(t){try{var e=this._findTrElement(t);this._remarksAsStaffRead(e);var a=e.getAttribute("reservation-index"),n=this.reservations[a],i=Object.assign({},n),s=moment(i.reservation_timestamp,"Y-M-D H:m:s");i.date_str=s.format("YYYY-MM-DD"),i.time_str=s.format("HH:mm"),Object.assign(window.vue_state,{reservation_dialog_content:i}),store.dispatch({type:SHOW_RESERVATION_DIALOG_CONTENT,reservation_dialog_content:i})}catch(t){}},_remarksAsStaffRead:function(t){try{var e=t.getAttribute("reservation-index");this.reservations[e].staff_read_state=!0}catch(t){}},_findTrElement:function(t){for(var e=t.target,a=[e].concat(t.path),n=0,i=null,s=!1;n<a.length&&!i;){var r=a[n];s||(s="INPUT"==r.tagName||"TEXTAREA"==r.tagName||"SELECT"==r.tagName||"BUTTON"==r.tagName),"TR"==r.tagName&&(i=r),n++}return i&&s?(this._remarksAsStaffRead(i),null):i},_updateSingleReservation:function(){var t=this.reservation_dialog_content;t.reservation_timestamp=t.date_str+" "+t.time_str+":00";for(var e=this.reservations,a=0,n=!1;a<e.length&&!n;)e[a].id==t.id&&(n=!0),a++;var i=e[a-1];Object.keys(i).forEach(function(e){i[e]=t[e]}),store.dispatch({type:HIDE_RESERVATION_DIALOG_CONTENT}),this._updateReservations()},_updateReservations:function(){var e=this.reservations,a={type:AJAX_UPDATE_RESERVATIONS,reservations:e};t.ajax_call(a)},_updateReservationPayment:function(t){console.log(t);var e=this,a=t.target;if("BUTTON"==a.tagName)try{var n=a.getAttribute("action"),i=a.getAttribute("reservation-index"),s=e.reservations[i],r=void 0;switch(n){default:break;case"refund":r=50;break;case"charge":r=200}r&&(s.payment_status=r),this._updateReservations()}catch(t){}}}})}},{key:"buildVueState",value:function(){return Object.assign({},store.getState())}},{key:"initViewReducer",value:function(t,e){switch(e.type){case INIT_VIEW:return!0;default:return t}}},{key:"initView",value:function(){store.dispatch({type:INIT_VIEW})}},{key:"reservationDialogContentReducer",value:function(t,e){switch(e.type){case SHOW_RESERVATION_DIALOG_CONTENT:return e.reservation_dialog_content;case HIDE_RESERVATION_DIALOG_CONTENT:return t;default:return t}}},{key:"reservationsReducer",value:function(t,e){switch(e.type){case UPDATE_SINGLE_RESERVATION:return t;case UPDATE_RESERVATIONS:var a=window.vue_state;return Object.assign({},a.reservations);default:return t}}},{key:"_findView",value:function(){this._hasFindView||(this._hasFindView=!0,this.reservation_dialog=$("#reservation-dialog"))}},{key:"event",value:function(){this._findView();var t=this;document.addEventListener("switch-outlet",function(e){var a=e.detail.outlet_id;store.dispatch({type:TOAST_SHOW,toast:{title:"Switch Outlet",content:"Fetching Data"}});var n={type:AJAX_REFETCHING_DATA,outlet_id:a};t.ajax_call(n)})}},{key:"view",value:function(){var t=window.store,e=this,a=document.querySelector("#redux-state");if(!a){document.querySelector("body");a=document.createElement("pre")}t.subscribe(function(){var n=t.getLastAction(),i=t.getState();t.getPrestate();if(a.innerHTML=syntaxHighlight(JSON.stringify(i,null,4)),n==SHOW_RESERVATION_DIALOG_CONTENT&&e.reservation_dialog.modal("show"),n==HIDE_RESERVATION_DIALOG_CONTENT&&e.reservation_dialog.modal("hide"),n==TOAST_SHOW){var s=i.toast;Object.assign(window.vue_state,{toast:s}),window.Toast.show()}n==SYNC_DATA&&Object.assign(window.vue_state,t.getState())})}},{key:"listener",value:function(){var t=window.store;t.subscribe(function(){t.getLastAction(),t.getState(),t.getPrestate()})}},{key:"ajax_call",value:function(t){var e=this;store.dispatch({type:TOAST_SHOW,toast:{title:"Calling ajax",content:"..."}});var a=store.getState();switch(t.type){case AJAX_UPDATE_RESERVATIONS:var n=e.url(""),i=a.outlet_id,s=Object.assign({},t,{outlet_id:i});$.ajax({url:n,data:s});break;case AJAX_REFETCHING_DATA:var r=e.url(""),o=Object.assign({},t);$.ajax({url:r,data:o});break;default:console.log("client side. ajax call not recognize the current acttion",t)}}},{key:"ajax_call_success",value:function(t){switch(t.statusMsg){case AJAX_SUCCESS:var e={title:"Update success",content:"＼＿ヘ(ᐖ◞)､ "};store.dispatch({type:TOAST_SHOW,toast:e}),store.dispatch({type:SYNC_DATA,data:t.data});break;case AJAX_REFETCHING_DATA_SUCCESS:store.dispatch({type:TOAST_SHOW,toast:{title:"Switch Outlet",content:"Fetched Data"}}),store.dispatch({type:SYNC_DATA,data:t.data});break;case AJAX_VALIDATE_FAIL:var a={title:"Validate Fail",content:JSON.stringify(t.data)};store.dispatch({type:TOAST_SHOW,toast:a});break;case AJAX_UNKNOWN_CASE:var n={title:"Unknown case",content:"xxx"};store.dispatch({type:TOAST_SHOW,toast:n})}}},{key:"ajax_call_error",value:function(t){console.log(t);var e={title:"Server error",content:"(⊙.☉)7"};store.dispatch({type:TOAST_SHOW,toast:e})}},{key:"ajax_call_complete",value:function(t){}},{key:"hack_ajax",value:function(){if(!this._hasHackAjax){this._hasHackAjax=!0;var t=this,e=$.ajax;$.ajax=function(a){var n=a.data,i=JSON.stringify(n);return a=Object.assign(a,{method:"POST",data:i,success:t.ajax_call_success,error:t.ajax_call_error,compelte:t.ajax_call_complete}),e(a)}}}},{key:"url",value:function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",a=window.store,n=a.getState(),i=n.base_url||"";i.endsWith("/")&&(i=e.substr(1)),e.startsWith("/")&&(e=e.substr(1));var t=i+"/"+e;return t.endsWith("/")&&(t=e.substr(1)),t}}]),t}(),adminReservations=new AdminReservations;