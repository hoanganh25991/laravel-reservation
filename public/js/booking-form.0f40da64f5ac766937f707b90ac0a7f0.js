"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),INIT_VIEW="INIT_VIEW",CHANGE_FORM_STEP="CHANGE_FORM_STEP",CHANGE_CUSTOMER_PHONE_COUNTRY_CODE="CHANGE_CUSTOMER_PHONE_COUNTRY_CODE",CHANGE_OUTLET="CHANGE_OUTLET",CHANGE_ADULT_PAX="CHANGE_ADULT_PAX",CHANGE_CHILDREN_PAX="CHANGE_CHILDREN_PAX",HAS_SELECTED_DAY="HAS_SELECTED_DAY",CHANGE_RESERVATION_DATE="CHANGE_RESERVATION_DATE",CHANGE_RESERVATION_TIME="CHANGE_RESERVATION_TIME",CHANGE_RESERVATION_CONFIRM_ID="CHANGE_RESERVATION_CONFIRM_ID",CHANGE_AVAILABLE_TIME="CHANGE_AVAILABLE_TIME",PAX_OVER="PAX_OVER",AJAX_CALL="AJAX_CALL",DIALOG_SHOW="DIALOG_SHOW",DIALOG_HAS_DATA="DIALOG_HAS_DATA",DIALOG_HIDDEN="DIALOG_HIDDEN",DIALOG_EXCEED_MIN_EXIST_TIME="DIALOG_EXCEED_MIN_EXIST_TIME",CHANGE_CUSTOMER_SALUTATION="CHANGE_CUSTOMER_SALUTATION",CHANGE_CUSTOMER_FIRST_NAME="CHANGE_CUSTOMER_FIRST_NAME",CHANGE_CUSTOMER_LAST_NAME="CHANGE_CUSTOMER_LAST_NAME",CHANGE_CUSTOMER_EMAIL="CHANGE_CUSTOMER_EMAIL",CHANGE_CUSTOMER_PHONE="CHANGE_CUSTOMER_PHONE",CHANGE_CUSTOMER_REMARKS="CHANGE_CUSTOMER_REMARKS",SYNC_RESERVATION="SYNC_RESERVATION",AJAX_SEARCH_AVAILABLE_TIME="AJAX_SEARCH_AVAILABLE_TIME",AJAX_SUBMIT_BOOKING="AJAX_SUBMIT_BOOKING",AJAX_AVAILABLE_TIME_FOUND="AJAX_AVAILABLE_TIME_FOUND",AJAX_RESERVATION_VALIDATE_FAIL="AJAX_RESERVATION_VALIDATE_FAIL",AJAX_RESERVATION_NO_LONGER_AVAILABLE="AJAX_RESERVATION_NO_LONGER_AVAILABLE",AJAX_RESERVATION_REQUIRED_DEPOSIT="AJAX_RESERVATION_REQUIRED_DEPOSIT",AJAX_RESERVATION_SUCCESS_CREATE="AJAX_RESERVATION_SUCCESS_CREATE",AJAX_BOOKING_CONDITION_VALIDATE_FAIL="AJAX_BOOKING_CONDITION_VALIDATE_FAIL",BookingForm=function(){function e(){_classCallCheck(this,e),this.buildRedux(),this.buildVue(),this.event(),this.listener(),this.view(),this.initView(),e.logObjectAssignPerformance()}return _createClass(e,[{key:"buildRedux",value:function(){var e=this.defaultState(),t=this,a=function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e,n=arguments[1];switch(n.type){case INIT_VIEW:return Object.assign({},a,{init_view:t.initViewReducer(a.init_view,n)});case CHANGE_FORM_STEP:return Object.assign({},a,{form_step:t.formStepReducer(a.form_step,n)});case CHANGE_OUTLET:return Object.assign({},a,{outlet:t.outletReducer(a.outlet,n)});case CHANGE_ADULT_PAX:case CHANGE_CHILDREN_PAX:return Object.assign({},a,{pax:t.paxReducer(a.pax,n)});case PAX_OVER:return Object.assign({},a,{pax_over:t.paxOverReducer(a.pax_over,n)});case HAS_SELECTED_DAY:return Object.assign({},a,{has_selected_day:t.hasSelectedDayReducer(a.has_selected_day,n)});case CHANGE_RESERVATION_DATE:case CHANGE_RESERVATION_TIME:case CHANGE_RESERVATION_CONFIRM_ID:case SYNC_RESERVATION:return Object.assign({},a,{reservation:t.reservationReducer(a.reservation,n)});case AJAX_CALL:return Object.assign({},a,{ajax_call:t.ajaxCallReducer(a.ajax_call,n)});case DIALOG_SHOW:case DIALOG_HAS_DATA:return Object.assign({},a,{dialog:t.dialogReducer(a.dialog,n)});case CHANGE_AVAILABLE_TIME:return Object.assign({},a,{available_time:t.availableTimeReducer(a.available_time,n)});case CHANGE_CUSTOMER_SALUTATION:case CHANGE_CUSTOMER_FIRST_NAME:case CHANGE_CUSTOMER_LAST_NAME:case CHANGE_CUSTOMER_EMAIL:case CHANGE_CUSTOMER_PHONE_COUNTRY_CODE:case CHANGE_CUSTOMER_PHONE:case CHANGE_CUSTOMER_REMARKS:return Object.assign({},a,{customer:t.customerReducer(a.customer,n)});default:return a}};window.store=Redux.createStore(a);var n=store.dispatch;store.dispatch=function(e){console.info(e.type),store.prestate=store.getState(),store.last_action=e.type,n(e)},store.getPrestate=function(){return store.prestate},store.getLastAction=function(){return store.last_action}}},{key:"getFrontendState",value:function(){return{init_view:!1,outlet:{},overall_min_pax:2,overall_max_pax:20,pax:{adult:0,children:0},reservation:{date:moment(),time:"",agree_term_condition:!1},dialog:{},available_time:{},ajax_call:0,has_selected_day:!1,form_step:"form-step-1",customer:{salutation:"Mr.",first_name:"",last_name:"",email:"",phone_country_code:"+65",phone:"",remarks:""},pax_over:"block"}}},{key:"defaultState",value:function(){var e=window.state||{},t=this.getFrontendState(),a=Object.assign(t,e);return(a.base_url&&a.base_url.includes("reservation.dev")||a.base_url.includes("localhost"))&&(a=Object.assign(a,{customer:{salutation:"Mr.",first_name:"Anh",last_name:"Le Hoang",email:"lehoanganh25991@gmail.com",phone_country_code:"+84",phone:"903865657",remarks:"hello world"}})),a}},{key:"buildVueState",value:function(){var e=Object.assign({},store.getState(),{available_time:{}}),t=e.overall_max_pax;return e=Object.assign(e,{adult_max_pax:t,children_max_pax:t})}},{key:"buildVue",value:function(){window.vue_state=this.buildVueState();this.vue=new Vue({el:"#form-step-container",data:window.vue_state,computed:{},methods:{_checkEmpty:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return Object.keys(e).filter(function(a){if(t.indexOf(a)!=-1)return!1;var n=e[a];return!(!isNaN(parseFloat(n))&&isFinite(n)||("time"!=a||"N/A"!=n)&&n)}).length>0},not_allowed_move_to_form_step_2:function(){var e=this._checkEmpty(this.reservation),t=this.pax.adult+this.pax.children,a=t<this.overall_min_pax||t>this.overall_max_pax;return e||a},not_allowed_move_to_form_step_3:function(){return this._checkEmpty(this.customer,["remarks"])},_updatePaxSelectBox:function(e,t){console.log("dynamicly recompute pax");var a=e.overall_max_pax,n=e.pax.adult,r=e.pax.children;switch(t){case"adult":var i=a-n;this.children_max_pax=i,i<r&&store.dispatch({type:CHANGE_CHILDREN_PAX,chidren_pax:i});break;case"children":var s=a-r;this.adult_max_pax=s,s<n&&store.dispatch({type:CHANGE_ADULT_PAX,adult_pax:s})}}}})}},{key:"paxOverReducer",value:function(e,t){switch(t.type){case"PAX_OVER":return"none";default:return e}}},{key:"customerReducer",value:function(e,t){switch(t.type){case CHANGE_CUSTOMER_SALUTATION:return Object.assign({},e,{salutation:t.salutation});case CHANGE_CUSTOMER_FIRST_NAME:return Object.assign({},e,{first_name:t.first_name});case CHANGE_CUSTOMER_LAST_NAME:return Object.assign({},e,{last_name:t.last_name});case CHANGE_CUSTOMER_EMAIL:return Object.assign({},e,{email:t.email});case CHANGE_CUSTOMER_PHONE_COUNTRY_CODE:return Object.assign({},e,{phone_country_code:t.phone_country_code});case CHANGE_CUSTOMER_PHONE:return Object.assign({},e,{phone:t.phone});case CHANGE_CUSTOMER_REMARKS:return Object.assign({},e,{remarks:t.remarks});default:return e}}},{key:"outletReducer",value:function(e,t){switch(t.type){case CHANGE_OUTLET:return t.outlet;default:return e}}},{key:"paxReducer",value:function(e,t){switch(t.type){case CHANGE_ADULT_PAX:return Object.assign({},e,{adult:Number(t.adult_pax)});case CHANGE_CHILDREN_PAX:return Object.assign({},e,{children:Number(t.children_pax)});default:return e}}},{key:"reservationReducer",value:function(e,t){switch(t.type){case CHANGE_RESERVATION_DATE:return Object.assign({},e,{date:t.date});case CHANGE_RESERVATION_TIME:return Object.assign({},e,{time:t.time});case CHANGE_RESERVATION_CONFIRM_ID:return Object.assign({},e,{confirm_id:t.confirm_id});case SYNC_RESERVATION:return Object.assign(e,t.reservation);default:return e}}},{key:"dialogReducer",value:function(e,t){switch(t.type){case DIALOG_SHOW:case DIALOG_HAS_DATA:return e;default:return e}}},{key:"availableTimeReducer",value:function(e,t){switch(t.type){case CHANGE_AVAILABLE_TIME:return t.available_time;default:return e}}},{key:"initViewReducer",value:function(e,t){switch(t.type){case INIT_VIEW:return!0;default:return e}}},{key:"ajaxCallReducer",value:function(e,t){switch(t.type){case AJAX_CALL:return Number(e)+1;default:return e}}},{key:"hasSelectedDayReducer",value:function(e,t){switch(t.type){case HAS_SELECTED_DAY:return!0;default:return e}}},{key:"formStepReducer",value:function(e,t){switch(t.type){case CHANGE_FORM_STEP:return t.form_step;default:return e}}},{key:"listener",value:function(){var e=window.store,t=this;e.subscribe(function(){var a=e.getState(),n=e.getPrestate(),r=e.getLastAction();n.ajax_call<a.ajax_call&&t.ajaxCall(),0==n.dialog.show&&1==a.dialog.show&&t.ajax_dialog.modal("show"),1==n.dialog.show&&0==a.dialog.show&&t.ajax_dialog.modal("hide"),r==CHANGE_ADULT_PAX&&t.vue._updatePaxSelectBox(a,"adult"),r==CHANGE_CHILDREN_PAX&&t.vue._updatePaxSelectBox(a,"children");var i=r==CHANGE_ADULT_PAX||r==CHANGE_CHILDREN_PAX,s=a.pax.adult+a.pax.children<a.overall_min_pax,_=a.pax.adult+a.pax.children>a.overall_max_pax;i&&(s||_)&&window.alert("There is a minimum pax of "+a.overall_min_pax+" for reservation at this outlet"),0==n.has_selected_day&&1==a.has_selected_day&&e.dispatch({type:AJAX_CALL,ajax_call:1});var o=r==CHANGE_ADULT_PAX||r==CHANGE_CHILDREN_PAX||r==CHANGE_OUTLET||r==CHANGE_RESERVATION_DATE,c=a.has_selected_day&&(n.pax.adult!=a.pax.adult||n.pax.children!=a.pax.children||n.outlet.id!=a.outlet.id||n.reservation.date!=a.reservation.date);o&&c&&e.dispatch({type:AJAX_CALL,ajax_call:1})})}},{key:"view",value:function(){var e=this;this.findView();var t=window.store,a=document.querySelector("#redux-state");if(!a){document.querySelector("body");a=document.createElement("pre")}t.subscribe(function(){var n=t.getState(),r=t.getLastAction();Object.assign(window.vue_state,n,{available_time:{}});var i=t.getPrestate();(n.base_url&&n.base_url.includes("reservation.dev")||n.base_url.includes("localhost"))&&(a.innerHTML=syntaxHighlight(JSON.stringify(n,null,4))),i.available_time!=n.available_time&&(e.updateSelectView(n.available_time),e.updateCalendarView(n.available_time)),(i.form_step!=n.form_step||0==i.init_view&&"form-step-1"==n.form_step)&&(console.info("pointToFormStep"),e.pointToFormStep()),r==DIALOG_SHOW&&e.ajax_dialog.modal("show"),r==DIALOG_HAS_DATA&&e.ajax_dialog.modal("hide")})}},{key:"initView",value:function(){var e={type:"INIT_VIEW"};store.dispatch(e)}},{key:"findView",value:function(){if(void 0!==this._hasRunFindView)return void console.info("_findView has run");this._hasRunFindView=!0,this.calendar=$("#calendar-box").Calendar(),this.adult_pax_select=document.querySelector('select[name="adult_pax"]'),this.children_pax_select=document.querySelector('select[name="children_pax"]'),this.ajax_dialog=$("#ajax-dialog"),this.outlet_select=document.querySelector('select[name="outlet_id"]'),this.time_select=document.querySelector('select[name="reservation_time"]'),this.customer_phone_country_code_input=document.querySelector('input[name="phone_country_code"]'),this.customer_salutation_select=document.querySelector('select[name="salutation"]'),this.customer_remarks_textarea=document.querySelector('textarea[name="remarks"]'),this.customer_firt_name_input=document.querySelector('input[name="firstname"]'),this.customer_last_name_input=document.querySelector('input[name="lastname"]'),this.customer_email_input=document.querySelector('input[name="email"]'),this.customer_phone_input=document.querySelector('input[name="phone"]'),this.form_step_container=document.querySelector("#form-step-container"),this.btn_form_nexts=document.querySelectorAll("button.btn-form-next")}},{key:"updateSelectView",value:function(e){var t=store.getState(),a=t.reservation.date,n=a.format("YYYY-MM-DD"),r=e[n];if(void 0===r&&(r=[]),0==r.length){var i={time:"N/A",session_name:""};r.push(i)}var s=this.time_select,_=r.reduce(function(e,t){return e+='<option value="'+t.time+'">'+t.session_name+" "+t.time+"</option>"},"");s.innerHTML=_,store.dispatch({type:CHANGE_RESERVATION_TIME,time:s.selectedOptions[0].value})}},{key:"updateCalendarView",value:function(e){var t=this.calendar;if(0!=Object.keys(e).length){this._addCalendarHelper(t);var a=Object.keys(e);t.day_tds.each(function(){var e=$(this),n=e.attr("year")+"-"+t._prefix2Dec(e.attr("month"))+"-"+t._prefix2Dec(e.attr("day"));a.includes(n)?t._pickable(e):t._unpickable(e)})}}},{key:"_addCalendarHelper",value:function(e){e.day_tds=$("#calendar-box").find("td"),e._prefix2Dec&&e._pickable&&!e._unpickable||(e._prefix2Dec=function(e){return e<10?"0"+e:e},e._pickable=function(e){e.removeClass("past"),e.addClass("day")},e._unpickable=function(e){e.removeClass("day"),e.addClass("past")})}},{key:"event",value:function(){var e=this;this.findView();var t=window.store,a=this.outlet_select;a.addEventListener("change",function(){var e=a.selectedOptions[0];t.dispatch({type:CHANGE_OUTLET,outlet:{id:e.value,name:e.innerText}})});var n=this.adult_pax_select;n.addEventListener("change",function(){var e=n.selectedOptions[0];t.dispatch({type:CHANGE_ADULT_PAX,adult_pax:e.value})});var r=this.children_pax_select;r.addEventListener("change",function(){var e=r.selectedOptions[0];t.dispatch({type:CHANGE_CHILDREN_PAX,children_pax:e.value})}),document.addEventListener("user-select-day",function(e){var a=moment(e.detail.day,"YYYY-MM-DD");t.dispatch({type:CHANGE_RESERVATION_DATE,date:a}),0==t.getState().has_selected_day&&t.dispatch({type:HAS_SELECTED_DAY})});var i=this.time_select;i.addEventListener("change",function(){console.log("time change");var e=i.selectedOptions[0],a={type:CHANGE_RESERVATION_TIME,time:e.value};t.dispatch(a)}),this.btn_form_nexts.forEach(function(e){e.addEventListener("click",function(){var a=e.getAttribute("destination");t.dispatch({type:CHANGE_FORM_STEP,form_step:a}),"form-step-3"==a&&t.dispatch({type:AJAX_CALL,ajax_call:1})})}),this.customer_salutation_select.addEventListener("change",function(){var e=this.selectedOptions[0].value;t.dispatch({type:CHANGE_CUSTOMER_SALUTATION,salutation:e})}),this.customer_firt_name_input.addEventListener("change",function(){var e=this.value;t.dispatch({type:CHANGE_CUSTOMER_FIRST_NAME,first_name:e})}),this.customer_last_name_input.addEventListener("change",function(){var e=this.value;t.dispatch({type:CHANGE_CUSTOMER_LAST_NAME,last_name:e})}),this.customer_email_input.addEventListener("change",function(){var e=this.value;t.dispatch({type:CHANGE_CUSTOMER_EMAIL,email:e})}),this.customer_phone_country_code_input.addEventListener("change",function(){var e=this.value;t.dispatch({type:CHANGE_CUSTOMER_PHONE_COUNTRY_CODE,phone_country_code:e})}),this.customer_phone_input.addEventListener("change",function(){var e=this.value;t.dispatch({type:CHANGE_CUSTOMER_PHONE,phone:e})}),this.customer_remarks_textarea.addEventListener("change",function(){var e=this.value;t.dispatch({type:CHANGE_CUSTOMER_REMARKS,remarks:e})}),document.addEventListener("PAYPAL_PAYMENT_SUCCESS",function(e){console.log(e);var a=e.detail,n=a.data.reservation;Object.assign(vue_state,{reservation:n}),t.dispatch({type:SYNC_RESERVATION,reservation:n})}),document.addEventListener("calendar-change-month",function(a){var n=t.getState();e.updateCalendarView(n.available_time)})}},{key:"ajaxCall",value:function(){var e=window.store,t=e.getState(),a=this;e.dispatch({type:DIALOG_SHOW,show:!0});var n={outlet_id:t.outlet.id,adult_pax:t.pax.adult,children_pax:t.pax.children,type:AJAX_SEARCH_AVAILABLE_TIME};if("form-step-3"==t.form_step){var r=t.reservation,i=r.date,s=r.time,_=i.format("YYYY-MM-DD")+" "+s+":00",o=t.customer,c=o.salutation,u=o.first_name,l=o.last_name,A=o.email,E=o.phone_country_code,d=o.phone,p=o.remarks;n=Object.assign(n,{reservation_timestamp:_,salutation:c,first_name:u,last_name:l,email:A,phone_country_code:E,phone:d,customer_remarks:p,type:AJAX_SUBMIT_BOOKING})}console.log(n),$.ajax({url:"",method:"POST",data:n,success:function(t){if(console.log(t),t.statusMsg==AJAX_RESERVATION_SUCCESS_CREATE){var a=t.data.reservation;return Object.assign(vue_state,{reservation:a}),void e.dispatch({type:SYNC_RESERVATION,reservation:a})}if(t.statusMsg==AJAX_AVAILABLE_TIME_FOUND){var n=t.data;return void e.dispatch({type:CHANGE_AVAILABLE_TIME,available_time:n})}},complete:function(t){console.log(t),e.dispatch({type:DIALOG_HAS_DATA,dialog_has_data:!0})},error:function(t){if(t=t.responseJSON,t.statusMsg==AJAX_BOOKING_CONDITION_VALIDATE_FAIL){return void window.alert("Booking condition validate fail")}if(t.statusMsg==AJAX_RESERVATION_NO_LONGER_AVAILABLE){var n=(t.data,"SORRY, Someone has book before you. Rerservation no longer available");return console.log(n,t.data),void window.alert(n)}if(t.statusMsg==AJAX_RESERVATION_REQUIRED_DEPOSIT){var r=t.data.reservation;Object.assign(vue_state,{reservation:r}),e.dispatch({type:SYNC_RESERVATION,reservation:r});var i=t.data,s=r.deposit,_=r.confirm_id,o=r.outlet_id,c=i.paypal_token,u=a.url("paypal");new PayPalAuthorize(c,{amount:s,confirm_id:_,outlet_id:o},u);return void console.log("REQUIRED DEPOSIT, payment amount: ",t.data)}if(t.statusMsg==AJAX_RESERVATION_VALIDATE_FAIL){var l=JSON.stringify(t.data),A="VALIDATE FAIL: "+l;console.log(A,t.data),window.alert(A);var E="form-step-1";try{var d=Object.keys(t.data)[0],p=window.store,O=p.getState();Object.keys(O.customer).indexOf(d)!=-1&&(E="form-step-2")}catch(e){}return void e.dispatch({type:CHANGE_FORM_STEP,form_step:E})}}})}},{key:"url",value:function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",a=window.store,n=a.getState(),r=n.base_url||"";r.endsWith("/")&&(r=t.substr(1)),t.startsWith("/")&&(t=t.substr(1));var e=r+"/"+t;return e.endsWith("/")&&(e=t.substr(1)),e}},{key:"pointToFormStep",value:function(){var e=store.getState();this.form_step_container.querySelectorAll(".form-step").forEach(function(t){var a=t.getAttribute("id"),n="scale(0,0)";a==e.form_step&&(n="scale(1,1)"),t.style.transform=n})}}],[{key:"logObjectAssignPerformance",value:function(){var e=Object.assign;Object.assign=function(){for(var t=arguments.length,a=Array(t),n=0;n<t;n++)a[n]=arguments[n];return Object.keys(a[0]).length>0&&(console.time("obj assign"),e.apply(Object,a),console.timeEnd("obj assign")),e.apply(Object,a)}}}]),e}(),bookingForm=new BookingForm;