"use strict";function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,a,n){return a&&e(t.prototype,a),n&&e(t,n),t}}(),INIT_VIEW="INIT_VIEW",CHANGE_FORM_STEP="CHANGE_FORM_STEP",CHANGE_CUSTOMER_PHONE_COUNTRY_CODE="CHANGE_CUSTOMER_PHONE_COUNTRY_CODE",CHANGE_SELECTED_OUTLET_ID="CHANGE_SELECTED_OUTLET_ID",CHANGE_ADULT_PAX="CHANGE_ADULT_PAX",CHANGE_CHILDREN_PAX="CHANGE_CHILDREN_PAX",HAS_SELECTED_DAY="HAS_SELECTED_DAY",CHANGE_RESERVATION="CHANGE_RESERVATION",CHANGE_RESERVATION_DATE="CHANGE_RESERVATION_DATE",CHANGE_RESERVATION_TIME="CHANGE_RESERVATION_TIME",CHANGE_RESERVATION_CONFIRM_ID="CHANGE_RESERVATION_CONFIRM_ID",CHANGE_AVAILABLE_TIME="CHANGE_AVAILABLE_TIME",SELECT_PAX="SELECT_PAX",PAX_OVER="PAX_OVER",AJAX_CALL="AJAX_CALL",DIALOG_SHOW="DIALOG_SHOW",DIALOG_HAS_DATA="DIALOG_HAS_DATA",DIALOG_HIDDEN="DIALOG_HIDDEN",DIALOG_EXCEED_MIN_EXIST_TIME="DIALOG_EXCEED_MIN_EXIST_TIME",CHANGE_CUSTOMER_SALUTATION="CHANGE_CUSTOMER_SALUTATION",CHANGE_CUSTOMER_FIRST_NAME="CHANGE_CUSTOMER_FIRST_NAME",CHANGE_CUSTOMER_LAST_NAME="CHANGE_CUSTOMER_LAST_NAME",CHANGE_CUSTOMER_EMAIL="CHANGE_CUSTOMER_EMAIL",CHANGE_CUSTOMER_PHONE="CHANGE_CUSTOMER_PHONE",CHANGE_CUSTOMER_REMARKS="CHANGE_CUSTOMER_REMARKS",SYNC_RESERVATION="SYNC_RESERVATION",AJAX_SEARCH_AVAILABLE_TIME="AJAX_SEARCH_AVAILABLE_TIME",AJAX_SUBMIT_BOOKING="AJAX_SUBMIT_BOOKING",AJAX_AVAILABLE_TIME_FOUND="AJAX_AVAILABLE_TIME_FOUND",AJAX_RESERVATION_VALIDATE_FAIL="AJAX_RESERVATION_VALIDATE_FAIL",AJAX_RESERVATION_NO_LONGER_AVAILABLE="AJAX_RESERVATION_NO_LONGER_AVAILABLE",AJAX_RESERVATION_REQUIRED_DEPOSIT="AJAX_RESERVATION_REQUIRED_DEPOSIT",AJAX_RESERVATION_SUCCESS_CREATE="AJAX_RESERVATION_SUCCESS_CREATE",AJAX_BOOKING_CONDITION_VALIDATE_FAIL="AJAX_BOOKING_CONDITION_VALIDATE_FAIL",SYNC_VUE_STATE="SYNC_VUE_STATE",UPDATE_CALENDAR_VIEW="UPDATE_CALENDAR_VIEW",NO_DATE_PICKED="NO_DATE_PICKED",BookingForm=function(){function e(){_classCallCheck(this,e),this.buildRedux(),this.buildVue()}return _createClass(e,[{key:"buildRedux",value:function(){var e=this.defaultState(),t=this,a=function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e,n=arguments[1];switch(n.type){case INIT_VIEW:return Object.assign({},a,{init_view:t.initViewReducer(a.init_view,n)});case CHANGE_FORM_STEP:return Object.assign({},a,{form_step:t.formStepReducer(a.form_step,n)});case HAS_SELECTED_DAY:return Object.assign({},a,{has_selected_day:t.hasSelectedDayReducer(a.has_selected_day,n)});case CHANGE_RESERVATION_DATE:case CHANGE_RESERVATION_TIME:case CHANGE_RESERVATION_CONFIRM_ID:case CHANGE_RESERVATION:case SYNC_RESERVATION:return Object.assign({},a,{reservation:t.reservationReducer(a.reservation,n)});case AJAX_CALL:return Object.assign({},a,{ajax_call:t.ajaxCallReducer(a.ajax_call,n)});case DIALOG_SHOW:case DIALOG_HAS_DATA:return Object.assign({},a,{dialog:t.dialogReducer(a.dialog,n)});case CHANGE_AVAILABLE_TIME:return Object.assign({},a,{available_time:t.availableTimeReducer(a.available_time,n)});case SELECT_PAX:return Object.assign({},a,{select_pax_times:t.selectPaxTimesReducer(a.select_pax_times,n)});case SYNC_VUE_STATE:return Object.assign({},a,n.vue_state);default:return a}};window.store=Redux.createStore(a);var n=store.dispatch;store.dispatch=function(e){console.info(e.type),store.prestate=store.getState(),store.last_action=e.type,n(e)},store.getPrestate=function(){return store.prestate},store.getLastAction=function(){return store.last_action}}},{key:"defaultState",value:function(){var e=window.state||{},t={init_view:!1,base_url:"",selected_outlet:{},selected_outlet_id:null,outlets:[],reservation:{outlet_id:null,adult_pax:0,children_pax:0,reservation_timestamp:"be computed base on date & time",agree_term_condition:!1,salutation:"Mr.",first_name:"",last_name:"",email:"",phone_country_code:"",phone:"",customer_remarks:""},dialog:{},available_time:{},has_selected_day:!1,form_step:"form-step-1",form_step_1_keys:["outlet_id","adult_pax","children_pax","agree_term_condition","date"],form_step_2_keys:["salutation","first_name","last_name","email","phone_country_code","phone"]},a=Object.assign(t,e);if(a.base_url&&a.base_url.includes("reservation.dev")||a.base_url.includes("localhost")){var n=Object.assign(a.reservation,{salutation:"Mr.",first_name:"Anh",last_name:"Le Hoang",email:"lehoanganh25991@gmail.com",phone_country_code:"+84",phone:"903865657",customer_remarks:"hello world"});a=Object.assign(a,{reservation:n})}return a}},{key:"buildVueState",value:function(){return{selected_outlet:{},selected_outlet_id:null,outlets:[],reservation:{date:null,time:null},available_time:{},available_time_on_reservation_date:[],no_answer_time:void 0,adult_pax_select:{start:-1,end:20},children_pax_select:{start:-1,end:20},has_changed_pax:null,form_step_1_keys:[],form_step_2_keys:[]}}},{key:"buildVue",value:function(){window.vue_state=this.buildVueState();var e=this;this.vue=new Vue({el:"#form-step-container",data:window.vue_state,beforeCreated:function(){},created:function(){},beforeMount:function(){},mounted:function(){e.event(),e.view(),e.listener(),e.initView()},beforeUpdate:function(){store.dispatch({type:SYNC_VUE_STATE,vue_state:window.vue_state})},updated:function(){},watch:{outlets:function(e){var t=e[0]||{};this.selected_outlet_id=t.id},selected_outlet_id:function(e){var t=Object.assign({},this.reservation,{outlet_id:e});this.reservation=t;var a=this.outlets.filter(function(t){return t.id==e});this.selected_outlet=a[0]||{}},available_time:function(e){var t=this.reservation.date,a=t?t.format("YYYY-MM-DD"):NO_DATE_PICKED;this.available_time_on_reservation_date=e[a]||[]},available_time_on_reservation_date:function(e){var t=this;if(!this.reservation.time){var a=e[0]||{},n=Object.assign({},this.reservation,{time:a.time});this.reservation=n}var r=e.filter(function(e){return e.time==t.reservation.time}),i=r.length>0;if(this.reservation.time&&!i){var _=e[0]||{},s=Object.assign({},this.reservation,{time:_.time});this.reservation=s}}},methods:{_checkEmpty:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],a=this.reservation;return e.filter(function(e){if(t.indexOf(e)!=-1)return!1;var n=a[e];return!(!isNaN(parseFloat(n))&&isFinite(n)||n)}).length>0},not_allowed_move_to_form_step_2:function(){var e=this._checkEmpty(this.form_step_1_keys),t=this.reservation,a=this.selected_outlet,n=t.adult_pax+t.children,r=n<a.overall_min_pax||n>a.overall_max_pax;return e||r},not_allowed_move_to_form_step_3:function(){return this._checkEmpty(this.form_step_2_keys,["remarks"])},_changePax:function(e){this.has_changed_pax=e},_fun:function(){this.selected_outlet_id,this.reservation;return Math.floor(10*Math.random())},_updatePaxSelectBox:function(t){try{var a=this.selected_outlet,n=this.reservation,r=(this.adult_pax_select,this.children_pax_select,"adult_pax"==t?"children_pax":"adult_pax"),i=this.has_changed_pax?this.has_changed_pax:r,_=this[t+"_select"];if(t==i){var s=_.start;return _.end-s}var o=a.overall_min_pax-n[i]-1,l=a.overall_max_pax-n[i];this.has_changed_pax||(o=-1,l=this.selected_outlet.overall_max_pax),o=o<-1?-1:o;var c={start:o,end:l};!e._shallowEqualObj(_,c)&&(this[t+"_select"]=c);var u=n[t],A=u<o+1||u>l,E=n;if(A){window.alert("There is a minimum pax of "+this.selected_outlet.overall_min_pax+" for reservation at this outlet");u=u-o+(u-l)<0?o+1:l,E=Object.assign({},n,_defineProperty({},t,u))}if(this.reservation=E,isNaN(l)||isNaN(o))throw"not a nummber of end|start";return l-o}catch(e){return 20}},_submitBooking:function(){e.ajaxCall({type:AJAX_SUBMIT_BOOKING})},_computeReservationTimestamp:function(e,t){if(e&&t){var a=moment(t,"HH:mm"),n=e;if(!n.isValid()||!n.isValid())return void console.warn("Why date, time specify but invalid when parsed???");var r=a.hour(),i=a.minute();return n.clone().hour(r).minute(i).format("X")}}}})}},{key:"_shallowEqualObj",value:function(e,t){if(Object.is(e,t))return!0;if("object"!==(void 0===e?"undefined":_typeof(e))||null===e||"object"!==(void 0===t?"undefined":_typeof(t))||null===t)return!1;var a=Object.keys(e),n=Object.keys(t);if(a.length!==n.length)return!1;for(var r=0;r<a.length;r++)if(!Object.prototype.hasOwnProperty.call(t,a[r])||!Object.is(e[a[r]],t[a[r]]))return!1;return!0}},{key:"paxOverReducer",value:function(e,t){switch(t.type){case"PAX_OVER":return"none";default:return e}}},{key:"customerReducer",value:function(e,t){switch(t.type){case CHANGE_CUSTOMER_SALUTATION:return Object.assign({},e,{salutation:t.salutation});case CHANGE_CUSTOMER_FIRST_NAME:return Object.assign({},e,{first_name:t.first_name});case CHANGE_CUSTOMER_LAST_NAME:return Object.assign({},e,{last_name:t.last_name});case CHANGE_CUSTOMER_EMAIL:return Object.assign({},e,{email:t.email});case CHANGE_CUSTOMER_PHONE_COUNTRY_CODE:return Object.assign({},e,{phone_country_code:t.phone_country_code});case CHANGE_CUSTOMER_PHONE:return Object.assign({},e,{phone:t.phone});case CHANGE_CUSTOMER_REMARKS:return Object.assign({},e,{remarks:t.remarks});default:return e}}},{key:"outletReducer",value:function(e,t){switch(t.type){case CHANGE_SELECTED_OUTLET_ID:return t.selected_outlet;default:return e}}},{key:"paxReducer",value:function(e,t){switch(t.type){case CHANGE_ADULT_PAX:return Object.assign({},e,{adult:Number(t.adult_pax)});case CHANGE_CHILDREN_PAX:return Object.assign({},e,{children:Number(t.children_pax)});default:return e}}},{key:"reservationReducer",value:function(e,t){switch(t.type){case CHANGE_RESERVATION_DATE:return Object.assign({},e,{date:t.date});case CHANGE_RESERVATION_TIME:return Object.assign({},e,{time:t.time});case CHANGE_RESERVATION_CONFIRM_ID:return Object.assign({},e,{confirm_id:t.confirm_id});case CHANGE_RESERVATION:return t.reservation;case SYNC_RESERVATION:return Object.assign({},e,t.reservation);default:return e}}},{key:"dialogReducer",value:function(e,t){switch(t.type){case DIALOG_SHOW:return!0;case DIALOG_HAS_DATA:return!1;default:return e}}},{key:"availableTimeReducer",value:function(e,t){switch(t.type){case CHANGE_AVAILABLE_TIME:return t.available_time;default:return e}}},{key:"initViewReducer",value:function(e,t){switch(t.type){case INIT_VIEW:return!0;default:return e}}},{key:"ajaxCallReducer",value:function(e,t){switch(t.type){case AJAX_CALL:return Number(e)+1;default:return e}}},{key:"hasSelectedDayReducer",value:function(e,t){switch(t.type){case HAS_SELECTED_DAY:return!0;default:return e}}},{key:"formStepReducer",value:function(e,t){switch(t.type){case CHANGE_FORM_STEP:return t.form_step;default:return e}}},{key:"selectPaxTimesReducer",value:function(e,t){switch(t.type){case SELECT_PAX:return e+1;default:return e}}},{key:"event",value:function(){var e=this;this._findView();var t=window.store;document.addEventListener("user-select-day",function(e){var a=moment(e.detail.day,"YYYY-MM-DD");t.dispatch({type:CHANGE_RESERVATION_DATE,date:a}),0==t.getState().has_selected_day&&t.dispatch({type:HAS_SELECTED_DAY})}),this.btn_form_nexts.forEach(function(e){e.addEventListener("click",function(){var a=e.getAttribute("destination");t.dispatch({type:CHANGE_FORM_STEP,form_step:a})})}),document.addEventListener("PAYPAL_PAYMENT_SUCCESS",function(e){console.log(e);var a=e.detail,n=a.data.reservation;Object.assign(vue_state,{reservation:n}),t.dispatch({type:SYNC_RESERVATION,reservation:n})}),document.addEventListener("calendar-change-month",function(t){e.updateCalendarView()})}},{key:"_changeBookingCondition",value:function(e,t){return e.outlet_id==t.outlet_id&&e.adult_pax==t.adult_pax&&e.children_pax==t.children_pax&&e.date==t.date}},{key:"view",value:function(){var e=this;this._findView();var t=window.store,a=this,n=document.querySelector("#redux-state");t.subscribe(function(){var r=t.getState(),i=t.getPrestate(),_=t.getLastAction(),s=r.base_url&&r.base_url.includes("reservation.dev")||r.base_url.includes("localhost");if(n&&s){var o=Object.assign({},r);if(o.available_time){Object.keys(o.available_time).length>14&&(delete o.available_time,console.warn("available_time is large, debug build HTML will slow app, removed it"))}n.innerHTML=syntaxHighlight(JSON.stringify(o,null,4))}i.available_time,r.available_time;(i.form_step!=r.form_step||0==i.init_view)&&a.pointToFormStep(),_==DIALOG_SHOW&&e.ajax_dialog.modal("show"),_==DIALOG_HAS_DATA&&a.ajax_dialog.modal("hide");var l=0==i.init_view,c=i.selected_outlet_id!=r.selected_outlet_id;(l||c)&&a.updateCalendarView();var u=!a._changeBookingCondition(i.reservation,r.reservation),A=0==i.has_selected_day&&1==r.has_selected_day;(r.has_selected_day&&u||A)&&a.ajaxCall({type:AJAX_SEARCH_AVAILABLE_TIME}),_==CHANGE_AVAILABLE_TIME&&a.updateCalendarView(),Object.assign(window.vue_state,r)})}},{key:"listener",value:function(){var e=window.store;e.subscribe(function(){e.getState(),e.getPrestate(),e.getLastAction()})}},{key:"initView",value:function(){var e={type:"INIT_VIEW"};store.dispatch(e)}},{key:"_findView",value:function(){this._hasRunFindView||(this._hasRunFindView=!0,this.calendar=$("#calendar-box").Calendar(),this.ajax_dialog=$("#ajax-dialog"),this.form_step_container=document.querySelector("#form-step-container"),this.btn_form_nexts=document.querySelectorAll("button.btn-form-next"))}},{key:"updateCalendarView",value:function(){for(var e=store.getState(),t=e.available_time,a=e.selected_outlet,n=a.max_days_in_advance,r=this.calendar,i=moment(),_=[],s=0;s<n;){var o=i.clone().add(s,"days");_.push(o),s++}var l=_.map(function(e){return e.format("YYYY-MM-DD")});this._addCalendarHelper(r),r.day_tds.each(function(){var e=$(this),a=e.attr("year"),n=r._prefix2Dec(e.attr("month")),i=r._prefix2Dec(e.attr("day")),_=a+"-"+n+"-"+i,s=l.includes(_),o=t[_],c=!!o&&o.length>0,u=0==Object.keys(t).length;s&&(c||u)?r._pickable(e):r._unpickable(e)})}},{key:"_addCalendarHelper",value:function(e){e.day_tds=$("#calendar-box").find("td"),e._prefix2Dec&&e._pickable&&e._unpickable||(e._prefix2Dec=function(e){return e<10?"0"+e:e},e._pickable=function(e){e.removeClass("past"),e.addClass("day")},e._unpickable=function(e){e.removeClass("day"),e.addClass("past")})}},{key:"ajaxCall",value:function(e){var t=window.store,a=t.getState(),n=this;t.dispatch({type:DIALOG_SHOW}),console.log("%c ajaxCall: "+e.type,"background:#FDD835");var r={};switch(e.type){case AJAX_SEARCH_AVAILABLE_TIME:var i=a.reservation,_=i.outlet_id,s=i.adult_pax,o=i.children_pax;Object.assign(r,{outlet_id:_,adult_pax:s,children_pax:o},{type:e.type});break;case AJAX_SUBMIT_BOOKING:Object.assign(r,a.reservation,{type:e.type});var l=n.vue,c=a.reservation,u=c.date,A=c.time,E=l._computeReservationTimestamp(u,A);console.log(E),r.reservation_timestamp=E,delete r.date}console.log("ajaxCall: data",r),$.ajax({url:"",method:"POST",data:r,success:function(e){switch(console.log(e),e.statusMsg){case AJAX_AVAILABLE_TIME_FOUND:var a=e.data.available_time;t.dispatch({type:CHANGE_AVAILABLE_TIME,available_time:a});break;case AJAX_RESERVATION_SUCCESS_CREATE:var n=e.data.reservation;t.dispatch({type:SYNC_RESERVATION,reservation:n});break;default:console.warn("Unknown case of res.statusMsg")}},error:function(e){console.log(e.responseJSON);var a=e.responseJSON;try{switch(a.statusMsg){case AJAX_BOOKING_CONDITION_VALIDATE_FAIL:var r=JSON.stringify(a.data);window.alert("Booking condition validate fail: "+r);break;case AJAX_RESERVATION_NO_LONGER_AVAILABLE:window.alert("SORRY, Someone has book before you. Rerservation no longer available");break;case AJAX_RESERVATION_REQUIRED_DEPOSIT:var i=a.data.reservation;t.dispatch({type:SYNC_RESERVATION,reservation:i});var _=i.deposit,s=i.confirm_id,o=i.outlet_id,l=a.data.paypal_token,c=n.url("paypal"),u={amount:_,outlet_id:o,confirm_id:s};new PayPalAuthorize(l,u,c);break;case AJAX_RESERVATION_VALIDATE_FAIL:var A=JSON.stringify(a.data);window.alert("Validate fail: "+A);var E="form-step-1";try{var d=Object.keys(a.data)[0];["first_name","last_name","email","phone_country_code","phone"].indexOf(d)!=-1&&(E="form-step-2")}catch(e){}t.dispatch({type:CHANGE_FORM_STEP,form_step:E})}}catch(e){console.warn("Unknown case of res or has error in code",e)}},complete:function(){t.dispatch({type:DIALOG_HAS_DATA})}})}},{key:"url",value:function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",a=window.store,n=a.getState(),r=n.base_url||"";r.endsWith("/")&&(r=t.substr(1)),t.startsWith("/")&&(t=t.substr(1));var e=r+"/"+t;return e.endsWith("/")&&(e=t.substr(1)),e}},{key:"pointToFormStep",value:function(){var e=store.getState();this.form_step_container.querySelectorAll(".form-step").forEach(function(t){var a=t.getAttribute("id"),n="scale(0,0)";a==e.form_step&&(n="scale(1,1)"),t.style.transform=n})}}]),e}(),bookingForm=new BookingForm;